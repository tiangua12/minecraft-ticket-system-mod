<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é“è·¯ç¥¨åŠ¡ç³»ç»Ÿ Â· æ§åˆ¶å°</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
    .theme-toggle {
      position: absolute;
      top: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 16px;
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .theme-toggle:hover {
      background: var(--card);
    }

    .theme-icon {
      font-size: 18px;
    }

    /* å¯¼èˆªå¡ç‰‡ */
    .nav-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .nav-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s ease;
      display: block;
    }

    .nav-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-color: var(--accent);
    }

    .nav-icon {
      font-size: 32px;
      margin-bottom: 16px;
    }

    .nav-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .nav-desc {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ä»ªè¡¨æ¿ç»Ÿè®¡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 48px;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
      margin: 12px 0;
    }

    .stat-label {
      color: var(--muted);
      font-weight: 700;
      font-size: 14px;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
      .nav-cards {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }

      .theme-toggle {
        position: static;
        margin-left: auto;
        order: 2;
      }

      .brand {
        flex-wrap: wrap;
      }
    }

    @media (max-width: 480px) {
      .nav-cards {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="theme.js"></script>
</head>
<body>
  <header class="brand" style="position: relative; padding: 20px 24px;">
    <div class="brand-title">é“è·¯ç¥¨åŠ¡ç³»ç»Ÿ Â· æ§åˆ¶å°</div>
    <nav class="tabs">
      <button class="tab active" data-tab="dashboard">ä»ªè¡¨ç›˜</button>
      <button class="tab" data-tab="station">è½¦ç«™ç¼–è¾‘</button>
      <button class="tab" data-tab="line">çº¿è·¯ç¼–è¾‘</button>
      <button class="tab" data-tab="ticket">ç¥¨åŠ¡ç®¡ç†</button>
      <button class="tab" data-tab="logs">æ“ä½œæ—¥å¿—</button>
      <button class="tab" data-tab="settings">ç³»ç»Ÿè®¾ç½®</button>
    </nav>
    <button id="themeToggle" class="theme-toggle">
      <span class="theme-icon">ğŸŒ™</span>
      <span id="themeLabel">æ·±è‰²æ¨¡å¼</span>
    </button>
  </header>

  <main>
    <!-- ä»ªè¡¨ç›˜ -->
    <section id="tab-dashboard" class="tab-panel show">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">è½¦ç«™æ•°é‡</div>
          <div class="stat-value" id="stationCount">0</div>
          <div style="color: var(--muted); font-size: 12px;">å·²æ³¨å†Œè½¦ç«™</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">çº¿è·¯æ•°é‡</div>
          <div class="stat-value" id="lineCount">0</div>
          <div style="color: var(--muted); font-size: 12px;">è¿è¥çº¿è·¯</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šæ—¥ç¥¨åŠ¡</div>
          <div class="stat-value" id="ticketCount">0</div>
          <div style="color: var(--muted); font-size: 12px;">ä»Šæ—¥å”®å‡ºç¥¨æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
          <div class="stat-value" style="font-size: 24px; color: var(--accent);" id="systemStatus">æ­£å¸¸</div>
          <div style="color: var(--muted); font-size: 12px;">API è¿æ¥æ­£å¸¸</div>
        </div>
      </div>

      <div class="nav-cards">
        <a href="station-edit.html" class="nav-card">
          <div class="nav-icon">ğŸš‰</div>
          <div class="nav-title">è½¦ç«™ç¼–è¾‘</div>
          <div class="nav-desc">æ·»åŠ ã€ç¼–è¾‘æˆ–åˆ é™¤è½¦ç«™ä¿¡æ¯ï¼Œè®¾ç½®è½¦ç«™åæ ‡ä¸å±æ€§ã€‚</div>
        </a>

        <a href="line-edit.html" class="nav-card">
          <div class="nav-icon">ğŸ›¤ï¸</div>
          <div class="nav-title">çº¿è·¯ç¼–è¾‘</div>
          <div class="nav-desc">åˆ›å»ºå’Œç®¡ç†é“è·¯çº¿è·¯ï¼Œè®¾ç½®è½¦ç«™é¡ºåºã€çº¿è·¯é¢œè‰²ä¸å±æ€§ã€‚</div>
        </a>

        <a href="console.html" class="nav-card">
          <div class="nav-icon">ğŸ«</div>
          <div class="nav-title">ç¥¨åŠ¡ç®¡ç†</div>
          <div class="nav-desc">ç®¡ç†è½¦ç¥¨é”€å”®ã€ç¥¨ä»·è®¾ç½®ã€çº¿è·¯ç¼–è¾‘ä¸ç¥¨ä»·è®¡ç®—ã€‚</div>
        </a>

        <a href="logs.html" class="nav-card">
          <div class="nav-icon">ğŸ“</div>
          <div class="nav-title">æ“ä½œæ—¥å¿—</div>
          <div class="nav-desc">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œè®°å½•ï¼Œæ”¯æŒæŒ‰IPã€ç±»å‹ç­›é€‰ä¸æ—¶é—´çº¿è§†å›¾ã€‚</div>
        </a>
      </div>
    </section>

    <!-- è½¦ç«™ç®¡ç† (åˆ†å±‚ç»“æ„) -->
    <section id="tab-station" class="tab-panel">
      <div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
        <h2 style="color: var(--text); margin-bottom: 24px;">è½¦ç«™ç®¡ç†</h2>

        <!-- è½¦ç«™åˆ—è¡¨è§†å›¾ -->
        <div id="station-list-view" class="station-view">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text); margin: 0;">è½¦ç«™åˆ—è¡¨</h3>
            <div style="display: flex; gap: 12px;">
              <button id="btn-new-station" class="btn primary" style="padding: 10px 20px;">æ–°å»ºè½¦ç«™</button>
              <button id="btn-refresh-stations" class="btn" style="padding: 10px 20px;">åˆ·æ–°</button>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <input type="text" id="search-stations" placeholder="æœç´¢è½¦ç«™ç¼–ç æˆ–åç§°..." style="width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;" />
          </div>

          <div id="stations-table-container" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--surface);">
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">è½¦ç«™ç¼–ç </th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">è½¦ç«™åç§°</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">è‹±æ–‡åç§°</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">åæ ‡</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="stations-tbody">
                <tr>
                  <td colspan="5" style="padding: 40px; text-align: center; color: var(--muted);">åŠ è½½ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 20px; font-size: 14px; color: var(--muted);">
            æç¤ºï¼šç‚¹å‡»"ç¼–è¾‘"è¿›å…¥è½¦ç«™è¯¦ç»†ç¼–è¾‘é¡µé¢ï¼Œæ”¯æŒè®¾ç½®åæ ‡ã€ä¿®æ”¹åç§°ç­‰ã€‚
          </div>
        </div>

        <!-- è½¦ç«™ç¼–è¾‘è§†å›¾ (åˆå§‹éšè—ï¼Œé€šè¿‡JavaScriptæ§åˆ¶) -->
        <div id="station-edit-view" class="station-view" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text); margin: 0;">è½¦ç«™ç¼–è¾‘</h3>
            <button id="btn-back-to-station-list" class="btn" style="padding: 10px 20px;">è¿”å›åˆ—è¡¨</button>
          </div>
          <div id="station-edit-container" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px;">
            <p style="color: var(--muted); margin-bottom: 20px; text-align: center;">
              è½¦ç«™ç¼–è¾‘åŠŸèƒ½å·²è¿ç§»åˆ°ç‹¬ç«‹é¡µé¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ã€‚
            </p>
            <div style="text-align: center;">
              <a id="station-edit-link" href="station-edit.html" class="btn primary" style="padding: 12px 32px; font-size: 16px;">å‰å¾€è½¦ç«™ç¼–è¾‘é¡µé¢</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- çº¿è·¯ç®¡ç† (åˆ†å±‚ç»“æ„) -->
    <section id="tab-line" class="tab-panel">
      <div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
        <h2 style="color: var(--text); margin-bottom: 24px;">çº¿è·¯ç®¡ç†</h2>

        <!-- çº¿è·¯åˆ—è¡¨è§†å›¾ -->
        <div id="line-list-view" class="line-view">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text); margin: 0;">çº¿è·¯åˆ—è¡¨</h3>
            <div style="display: flex; gap: 12px;">
              <button id="btn-new-line" class="btn primary" style="padding: 10px 20px;">æ–°å»ºçº¿è·¯</button>
              <button id="btn-refresh-lines" class="btn" style="padding: 10px 20px;">åˆ·æ–°</button>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <input type="text" id="search-lines" placeholder="æœç´¢çº¿è·¯IDæˆ–åç§°..." style="width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;" />
          </div>

          <div id="lines-table-container" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--surface);">
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">çº¿è·¯ID</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">çº¿è·¯åç§°</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">é¢œè‰²</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">è½¦ç«™æ•°é‡</th>
                  <th style="padding: 16px; text-align: left; color: var(--text); font-weight: 700; border-bottom: 1px solid var(--border);">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="lines-tbody">
                <tr>
                  <td colspan="5" style="padding: 40px; text-align: center; color: var(--muted);">åŠ è½½ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 20px; font-size: 14px; color: var(--muted);">
            æç¤ºï¼šç‚¹å‡»"ç¼–è¾‘"è¿›å…¥çº¿è·¯è¯¦ç»†ç¼–è¾‘é¡µé¢ï¼Œæ”¯æŒæ‹–æ‹½æ’åºè½¦ç«™ã€è®¾ç½®çº¿è·¯é¢œè‰²ç­‰ã€‚
          </div>
        </div>

        <!-- çº¿è·¯ç¼–è¾‘è§†å›¾ (åˆå§‹éšè—ï¼Œé€šè¿‡JavaScriptæ§åˆ¶) -->
        <div id="line-edit-view" class="line-view" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text); margin: 0;">çº¿è·¯ç¼–è¾‘</h3>
            <button id="btn-back-to-list" class="btn" style="padding: 10px 20px;">è¿”å›åˆ—è¡¨</button>
          </div>
          <div id="line-edit-container" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px;">
            <p style="color: var(--muted); margin-bottom: 20px; text-align: center;">
              çº¿è·¯ç¼–è¾‘åŠŸèƒ½å·²è¿ç§»åˆ°ç‹¬ç«‹é¡µé¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ã€‚
            </p>
            <div style="text-align: center;">
              <a id="line-edit-link" href="line-edit.html" class="btn primary" style="padding: 12px 32px; font-size: 16px;">å‰å¾€çº¿è·¯ç¼–è¾‘é¡µé¢</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ç¥¨åŠ¡ç®¡ç† (é‡å®šå‘) -->
    <section id="tab-ticket" class="tab-panel">
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ«</div>
        <h2 style="color: var(--text); margin-bottom: 16px;">ç¥¨åŠ¡ç®¡ç†åŠŸèƒ½å·²ç‹¬ç«‹</h2>
        <p style="color: var(--muted); max-width: 500px; margin: 0 auto 30px;">
          ç¥¨åŠ¡ç®¡ç†åŠŸèƒ½å·²è¿ç§»åˆ°ç‹¬ç«‹æ§åˆ¶å°é¡µé¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ã€‚
        </p>
        <a href="console.html" class="btn primary" style="padding: 12px 32px; font-size: 16px;">å‰å¾€ç¥¨åŠ¡ç®¡ç†é¡µé¢</a>
      </div>
    </section>

    <!-- æ“ä½œæ—¥å¿— (é‡å®šå‘) -->
    <section id="tab-logs" class="tab-panel">
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
        <h2 style="color: var(--text); margin-bottom: 16px;">æ“ä½œæ—¥å¿—åŠŸèƒ½å·²ç‹¬ç«‹</h2>
        <p style="color: var(--muted); max-width: 500px; margin: 0 auto 30px;">
          æ“ä½œæ—¥å¿—åŠŸèƒ½å·²è¿ç§»åˆ°ç‹¬ç«‹é¡µé¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ã€‚
        </p>
        <a href="logs.html" class="btn primary" style="padding: 12px 32px; font-size: 16px;">å‰å¾€æ“ä½œæ—¥å¿—é¡µé¢</a>
      </div>
    </section>

    <!-- ç³»ç»Ÿè®¾ç½® -->
    <section id="tab-settings" class="tab-panel">
      <div style="max-width: 800px; margin: 0 auto; padding: 24px;">
        <h2 style="color: var(--text); margin-bottom: 24px;">ç³»ç»Ÿè®¾ç½®</h2>

        <!-- API é…ç½® -->
        <div class="setting-card" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 24px;">
          <h3 style="color: var(--text); margin-bottom: 16px;">API é…ç½®</h3>
          <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
            é…ç½®åç«¯ API æœåŠ¡å™¨åœ°å€ã€‚é»˜è®¤ä½¿ç”¨ 127.0.0.1ï¼ˆæœ¬åœ°æ¸¸æˆå†…æœåŠ¡å™¨ï¼‰ã€‚
            å¦‚æœæ¸¸æˆå†…é…ç½®äº† API åœ°å€ï¼Œå°†ä¼˜å…ˆä½¿ç”¨æ¸¸æˆå†…é…ç½®ã€‚
          </p>

          <div style="display: grid; gap: 16px;">
            <div>
              <label style="display: block; color: var(--text); margin-bottom: 8px; font-weight: 700;">API åŸºç¡€åœ°å€</label>
              <input type="text" id="apiBase" placeholder="http://127.0.0.1:23333/api" style="width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;" />
              <div style="display: flex; gap: 12px; margin-top: 12px;">
                <button id="saveApiConfig" class="btn primary" style="padding: 10px 20px;">ä¿å­˜åˆ°æµè§ˆå™¨</button>
                <button id="clearApiCache" class="btn" style="padding: 10px 20px;">æ¸…é™¤ç¼“å­˜å¹¶ä½¿ç”¨é»˜è®¤</button>
                <button id="loadGameConfig" class="btn" style="padding: 10px 20px;">ä»æ¸¸æˆå†…é…ç½®åŠ è½½</button>
              </div>
            </div>

            <div style="background: var(--surface); border-radius: 8px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <strong style="color: var(--text);">å½“å‰ä½¿ç”¨çš„ API åœ°å€</strong>
                <span id="apiStatus" style="font-size: 12px; padding: 4px 8px; border-radius: 12px; background: var(--accent); color: white;">é»˜è®¤</span>
              </div>
              <code id="currentApiUrl" style="display: block; padding: 12px; background: var(--card); border-radius: 6px; font-family: monospace; color: var(--text); word-break: break-all;">http://127.0.0.1:23333/api</code>
              <div style="margin-top: 12px; font-size: 12px; color: var(--muted);">
                <div>ä¼˜å…ˆçº§ï¼šæ¸¸æˆå†…é…ç½® > æµè§ˆå™¨å­˜å‚¨ > é»˜è®¤åœ°å€</div>
                <div id="apiSourceInfo" style="margin-top: 4px;">æ¥æºï¼šé»˜è®¤åœ°å€</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ä¸»é¢˜è®¾ç½® -->
        <div class="setting-card" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 24px;">
          <h3 style="color: var(--text); margin-bottom: 16px;">ç•Œé¢è®¾ç½®</h3>
          <div style="display: grid; gap: 16px;">
            <div>
              <label style="display: block; color: var(--text); margin-bottom: 8px; font-weight: 700;">ä¸»é¢˜æ¨¡å¼</label>
              <select id="colorMode" style="width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
                <option value="dark">æ·±è‰²æ¨¡å¼</option>
                <option value="light">æµ…è‰²æ¨¡å¼</option>
              </select>
            </div>
            <div style="display: flex; gap: 12px;">
              <button id="saveTheme" class="btn primary" style="padding: 10px 20px;">ä¿å­˜ä¸»é¢˜è®¾ç½®</button>
            </div>
          </div>
        </div>

        <!-- æ•°æ®ç®¡ç† -->
        <div class="setting-card" style="background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px;">
          <h3 style="color: var(--text); margin-bottom: 16px;">æ•°æ®ç®¡ç†</h3>
          <p style="color: var(--muted); margin-bottom: 20px; font-size: 14px;">
            å¯¼å‡ºç³»ç»Ÿæ•°æ®ä¸º JSON æ–‡ä»¶ï¼Œæˆ–ä» JSON æ–‡ä»¶å¯¼å…¥æ•°æ®ã€‚
          </p>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button id="exportData" class="btn primary" style="padding: 10px 20px;">å¯¼å‡ºæ•°æ® (JSON)</button>
            <label class="btn" style="padding: 10px 20px; cursor: pointer;">
              å¯¼å…¥æ•°æ® (JSON)
              <input id="importData" type="file" accept="application/json" style="display: none;" />
            </label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼ˆä½¿ç”¨å…¬å…±æ¨¡å—ï¼‰
    // ThemeManagerä¼šè‡ªåŠ¨åˆå§‹åŒ–

    // ==================== APIé…ç½®ç®¡ç† ====================
    const ApiConfigManager = {
      // å­˜å‚¨é”®å
      STORAGE_KEYS: {
        API_BASE: 'ticketsystem_api_base',
        API_SOURCE: 'ticketsystem_api_source'
      },

      // é»˜è®¤APIåœ°å€
      DEFAULT_API_BASE: 'http://127.0.0.1:23333/api',

      // å½“å‰ä½¿ç”¨çš„APIåŸºç¡€åœ°å€
      currentApiBase: null,
      currentSource: null,

      // åˆå§‹åŒ–ï¼šç¡®å®šè¦ä½¿ç”¨çš„APIåœ°å€
      async init() {
        try {
          // 1. å°è¯•ä»æ¸¸æˆé…ç½®è·å–
          const gameConfig = await this.fetchGameConfig();
          const gameApiBase = gameConfig?.game_api_base || '';

          // 2. ä»æµè§ˆå™¨æœ¬åœ°å­˜å‚¨è·å–
          const storedApiBase = localStorage.getItem(this.STORAGE_KEYS.API_BASE);
          const storedSource = localStorage.getItem(this.STORAGE_KEYS.API_SOURCE);

          // 3. åº”ç”¨ä¼˜å…ˆçº§ï¼šæ¸¸æˆé…ç½® > æµè§ˆå™¨å­˜å‚¨ > é»˜è®¤åœ°å€
          if (gameApiBase && gameApiBase.trim() !== '') {
            this.currentApiBase = gameApiBase.trim();
            this.currentSource = 'game_config';
            console.log('ä½¿ç”¨æ¸¸æˆå†…é…ç½®çš„APIåœ°å€:', this.currentApiBase);
          } else if (storedApiBase && storedApiBase.trim() !== '') {
            this.currentApiBase = storedApiBase.trim();
            this.currentSource = storedSource || 'browser_storage';
            console.log('ä½¿ç”¨æµè§ˆå™¨å­˜å‚¨çš„APIåœ°å€:', this.currentApiBase);
          } else {
            this.currentApiBase = this.DEFAULT_API_BASE;
            this.currentSource = 'default';
            console.log('ä½¿ç”¨é»˜è®¤APIåœ°å€:', this.currentApiBase);
          }

          // æ›´æ–°UIæ˜¾ç¤º
          this.updateUi();

          // è®¾ç½®å…¨å±€fetchå‡½æ•°ä½¿ç”¨å½“å‰APIåœ°å€
          this.overrideFetch();

          return this.currentApiBase;
        } catch (error) {
          console.error('APIé…ç½®åˆå§‹åŒ–å¤±è´¥:', error);
          this.currentApiBase = this.DEFAULT_API_BASE;
          this.currentSource = 'default';
          this.updateUi();
          this.overrideFetch();
          return this.currentApiBase;
        }
      },

      // ä»æœåŠ¡å™¨è·å–æ¸¸æˆé…ç½®
      async fetchGameConfig() {
        try {
          // ä½¿ç”¨é»˜è®¤åœ°å€è·å–é…ç½®
          const response = await fetch('/api/config');
          if (response.ok) {
            return await response.json();
          }
          return null;
        } catch (error) {
          console.warn('è·å–æ¸¸æˆé…ç½®å¤±è´¥:', error);
          return null;
        }
      },

      // æ›´æ–°UIæ˜¾ç¤º
      updateUi() {
        const apiBaseInput = document.getElementById('apiBase');
        const currentApiUrl = document.getElementById('currentApiUrl');
        const apiStatus = document.getElementById('apiStatus');
        const apiSourceInfo = document.getElementById('apiSourceInfo');

        if (apiBaseInput) {
          apiBaseInput.value = this.currentApiBase;
        }

        if (currentApiUrl) {
          currentApiUrl.textContent = this.currentApiBase;
        }

        if (apiStatus) {
          let statusText = 'é»˜è®¤';
          let statusColor = 'var(--accent)';

          switch (this.currentSource) {
            case 'game_config':
              statusText = 'æ¸¸æˆé…ç½®';
              statusColor = 'var(--success)';
              break;
            case 'browser_storage':
              statusText = 'æµè§ˆå™¨å­˜å‚¨';
              statusColor = 'var(--warning)';
              break;
            case 'default':
              statusText = 'é»˜è®¤';
              statusColor = 'var(--accent)';
              break;
          }

          apiStatus.textContent = statusText;
          apiStatus.style.backgroundColor = statusColor;
        }

        if (apiSourceInfo) {
          let sourceText = 'æ¥æºï¼š';
          switch (this.currentSource) {
            case 'game_config':
              sourceText += 'æ¸¸æˆå†…é…ç½®';
              break;
            case 'browser_storage':
              sourceText += 'æµè§ˆå™¨æœ¬åœ°å­˜å‚¨';
              break;
            case 'default':
              sourceText += 'é»˜è®¤åœ°å€';
              break;
          }
          apiSourceInfo.textContent = sourceText;
        }
      },

      // ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨
      saveToBrowser(apiBase) {
        const trimmed = apiBase.trim();
        if (!trimmed) {
          alert('APIåœ°å€ä¸èƒ½ä¸ºç©º');
          return false;
        }

        try {
          // ç®€å•éªŒè¯URLæ ¼å¼
          new URL(trimmed);
        } catch (error) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URLæ ¼å¼ï¼ˆå¦‚ http://127.0.0.1:23333/apiï¼‰');
          return false;
        }

        localStorage.setItem(this.STORAGE_KEYS.API_BASE, trimmed);
        localStorage.setItem(this.STORAGE_KEYS.API_SOURCE, 'browser_storage');

        // é‡æ–°åˆå§‹åŒ–
        this.init();

        alert('APIåœ°å€å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨');
        return true;
      },

      // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œä½¿ç”¨é»˜è®¤åœ°å€
      clearBrowserCache() {
        localStorage.removeItem(this.STORAGE_KEYS.API_BASE);
        localStorage.removeItem(this.STORAGE_KEYS.API_SOURCE);

        // é‡æ–°åˆå§‹åŒ–
        this.init();

        alert('å·²æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œä½¿ç”¨é»˜è®¤APIåœ°å€');
      },

      // ä»æ¸¸æˆé…ç½®åŠ è½½
      async loadFromGameConfig() {
        try {
          const gameConfig = await this.fetchGameConfig();
          const gameApiBase = gameConfig?.game_api_base || '';

          if (gameApiBase && gameApiBase.trim() !== '') {
            this.currentApiBase = gameApiBase.trim();
            this.currentSource = 'game_config';
            this.updateUi();
            alert('å·²åŠ è½½æ¸¸æˆå†…é…ç½®çš„APIåœ°å€');
          } else {
            alert('æ¸¸æˆå†…æœªé…ç½®APIåœ°å€ï¼Œè¯·å…ˆåœ¨æ¸¸æˆé…ç½®ä¸­è®¾ç½®');
          }
        } catch (error) {
          console.error('åŠ è½½æ¸¸æˆé…ç½®å¤±è´¥:', error);
          alert('åŠ è½½æ¸¸æˆé…ç½®å¤±è´¥: ' + error.message);
        }
      },

      // é‡å†™fetchå‡½æ•°ï¼Œè‡ªåŠ¨ä½¿ç”¨å½“å‰APIåœ°å€
      overrideFetch() {
        const originalFetch = window.fetch;
        const apiBase = this.currentApiBase;

        window.fetch = async function(resource, options) {
          let url = resource;

          // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¸”ä¸æ˜¯ä»¥ /api å¼€å¤´ï¼ˆé™æ€èµ„æºï¼‰ï¼Œåˆ™æ·»åŠ APIåŸºç¡€åœ°å€
          if (typeof resource === 'string' && resource.startsWith('/api')) {
            // å¦‚æœå½“å‰APIåœ°å€ä¸æ˜¯é»˜è®¤åœ°å€ï¼Œä¸”è¯·æ±‚çš„æ˜¯APIè·¯å¾„ï¼Œåˆ™æ›¿æ¢åŸºç¡€åœ°å€
            if (apiBase !== ApiConfigManager.DEFAULT_API_BASE) {
              // ç§»é™¤é»˜è®¤çš„åŸºç¡€éƒ¨åˆ†ï¼Œæ·»åŠ å½“å‰APIåŸºç¡€åœ°å€
              const apiPath = resource;
              url = apiBase.replace(/\/api$/, '') + apiPath;
            }
          }

          return originalFetch.call(window, url, options);
        };
      }
    };

    // ç³»ç»Ÿè®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupSystemSettings() {
      // ä¿å­˜APIé…ç½®æŒ‰é’®
      const saveApiConfigBtn = document.getElementById('saveApiConfig');
      if (saveApiConfigBtn) {
        saveApiConfigBtn.addEventListener('click', () => {
          const apiBaseInput = document.getElementById('apiBase');
          if (apiBaseInput) {
            ApiConfigManager.saveToBrowser(apiBaseInput.value);
          }
        });
      }

      // æ¸…é™¤APIç¼“å­˜æŒ‰é’®
      const clearApiCacheBtn = document.getElementById('clearApiCache');
      if (clearApiCacheBtn) {
        clearApiCacheBtn.addEventListener('click', () => {
          if (confirm('ç¡®å®šè¦æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶ä½¿ç”¨é»˜è®¤APIåœ°å€å—ï¼Ÿ')) {
            ApiConfigManager.clearBrowserCache();
          }
        });
      }

      // ä»æ¸¸æˆé…ç½®åŠ è½½æŒ‰é’®
      const loadGameConfigBtn = document.getElementById('loadGameConfig');
      if (loadGameConfigBtn) {
        loadGameConfigBtn.addEventListener('click', () => {
          ApiConfigManager.loadFromGameConfig();
        });
      }

      // ä¸»é¢˜ä¿å­˜æŒ‰é’®
      const saveThemeBtn = document.getElementById('saveTheme');
      if (saveThemeBtn) {
        saveThemeBtn.addEventListener('click', () => {
          const colorMode = document.getElementById('colorMode');
          if (colorMode) {
            const theme = colorMode.value;
            window.ThemeManager.setTheme(theme);
            alert('ä¸»é¢˜è®¾ç½®å·²ä¿å­˜');
          }
        });
      }

      // æ•°æ®å¯¼å‡ºæŒ‰é’®
      const exportDataBtn = document.getElementById('exportData');
      if (exportDataBtn) {
        exportDataBtn.addEventListener('click', () => {
          window.open('/api/export', '_blank');
        });
      }

      // æ•°æ®å¯¼å…¥æ–‡ä»¶é€‰æ‹©
      const importDataInput = document.getElementById('importData');
      if (importDataInput) {
        importDataInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;

          if (!file.name.endsWith('.json')) {
            alert('è¯·é€‰æ‹©JSONæ–‡ä»¶');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = JSON.parse(e.target.result);
              // è¿™é‡Œå¯ä»¥æ·»åŠ æ•°æ®å¯¼å…¥é€»è¾‘
              alert('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œæ•°æ®å¯¼å…¥åŠŸèƒ½å¾…å®ç°');
            } catch (error) {
              alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
            }
          };
          reader.readAsText(file);

          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
          event.target.value = '';
        });
      }

      // åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©æ¡†
      const colorMode = document.getElementById('colorMode');
      if (colorMode) {
        // è®¾ç½®å½“å‰ä¸»é¢˜
        const currentTheme = window.ThemeManager.getCurrentTheme();
        colorMode.value = currentTheme;

        // ç›‘å¬ä¸»é¢˜å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°é€‰æ‹©æ¡†
        window.ThemeManager.onThemeChange((theme) => {
          colorMode.value = theme;
        });
      }
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tab-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');

        // æ£€æŸ¥æ˜¯å¦ä¸ºéœ€è¦ç›´æ¥è·³è½¬çš„æ ‡ç­¾
        if (targetTab === 'ticket') {
          // ç›´æ¥è·³è½¬åˆ°ç¥¨åŠ¡ç®¡ç†é¡µé¢
          window.location.href = 'console.html';
          return;
        }

        if (targetTab === 'logs') {
          // ç›´æ¥è·³è½¬åˆ°æ“ä½œæ—¥å¿—é¡µé¢
          window.location.href = 'logs.html';
          return;
        }

        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
        panels.forEach(panel => {
          panel.classList.remove('show');
          if (panel.id === `tab-${targetTab}`) {
            panel.classList.add('show');
          }
        });
      });
    });

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch('/api/stations');
        if (response.ok) {
          const stations = await response.json();
          document.getElementById('stationCount').textContent = stations.length;
        }

        const linesResponse = await fetch('/api/lines');
        if (linesResponse.ok) {
          const lines = await linesResponse.json();
          document.getElementById('lineCount').textContent = lines.length;
        }

        // å°è¯•è·å–ä»Šæ—¥ç¥¨åŠ¡æ•°æ®
        const ticketsResponse = await fetch('/api/tickets');
        if (ticketsResponse.ok) {
          const data = await ticketsResponse.json();
          if (data.ok && data.tickets) {
            const today = new Date().toISOString().split('T')[0];
            const todayTickets = data.tickets.filter(t => {
              const ticketDate = new Date(t.last_update_ts).toISOString().split('T')[0];
              return ticketDate === today;
            });
            document.getElementById('ticketCount').textContent = todayTickets.length;
          }
        }

        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        const healthResponse = await fetch('/api/health');
        if (healthResponse.ok) {
          document.getElementById('systemStatus').textContent = 'æ­£å¸¸';
          document.getElementById('systemStatus').style.color = 'var(--accent)';
        } else {
          document.getElementById('systemStatus').textContent = 'å¼‚å¸¸';
          document.getElementById('systemStatus').style.color = 'var(--danger)';
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        document.getElementById('systemStatus').textContent = 'ç¦»çº¿';
        document.getElementById('systemStatus').style.color = 'var(--warning)';
      }
    }

    // çº¿è·¯ç®¡ç†åŠŸèƒ½
    function initLineManagement() {
      const btnNewLine = document.getElementById('btn-new-line');
      const btnRefreshLines = document.getElementById('btn-refresh-lines');
      const btnBackToList = document.getElementById('btn-back-to-list');
      const searchLinesInput = document.getElementById('search-lines');
      const lineListView = document.getElementById('line-list-view');
      const lineEditView = document.getElementById('line-edit-view');
      const lineEditLink = document.getElementById('line-edit-link');

      if (!btnNewLine) return; // å¦‚æœä¸åœ¨çº¿è·¯ç®¡ç†æ ‡ç­¾é¡µï¼Œåˆ™è·³è¿‡

      let allLines = [];
      let filteredLines = [];

      // åŠ è½½çº¿è·¯åˆ—è¡¨
      async function loadLines() {
        try {
          const response = await fetch('/api/lines');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          allLines = await response.json();
          filterLines();
        } catch (error) {
          console.error('åŠ è½½çº¿è·¯åˆ—è¡¨å¤±è´¥:', error);
          updateLinesTable([{ error: true, message: 'åŠ è½½å¤±è´¥: ' + error.message }]);
        }
      }

      // è¿‡æ»¤çº¿è·¯
      function filterLines() {
        const searchTerm = searchLinesInput.value.toLowerCase().trim();
        if (!searchTerm) {
          filteredLines = allLines;
        } else {
          filteredLines = allLines.filter(line =>
            (line.id && line.id.toLowerCase().includes(searchTerm)) ||
            (line.name && line.name.toLowerCase().includes(searchTerm))
          );
        }
        updateLinesTable(filteredLines);
      }

      // æ›´æ–°è¡¨æ ¼
      function updateLinesTable(lines) {
        const tbody = document.getElementById('lines-tbody');
        if (!tbody) return;

        if (lines.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 40px; text-align: center; color: var(--muted);">
                æš‚æ— çº¿è·¯æ•°æ®
              </td>
            </tr>
          `;
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å¯¹è±¡
        if (lines[0] && lines[0].error) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 40px; text-align: center; color: var(--danger);">
                ${lines[0].message || 'åŠ è½½çº¿è·¯åˆ—è¡¨å¤±è´¥'}
              </td>
            </tr>
          `;
          return;
        }

        let html = '';
        lines.forEach(line => {
          const stationCount = line.stations ? line.stations.length : 0;
          html += `
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 16px; color: var(--text);">
                <strong>${line.id || ''}</strong>
              </td>
              <td style="padding: 16px; color: var(--text);">
                ${line.name || ''}
              </td>
              <td style="padding: 16px;">
                ${line.color ? `
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; border-radius: 4px; background: ${line.color}; border: 1px solid var(--border);"></div>
                    <span style="color: var(--text); font-family: monospace; font-size: 12px;">${line.color}</span>
                  </div>
                ` : '<span style="color: var(--muted);">æœªè®¾ç½®</span>'}
              </td>
              <td style="padding: 16px; color: var(--text);">
                ${stationCount} ä¸ªè½¦ç«™
              </td>
              <td style="padding: 16px;">
                <div style="display: flex; gap: 8px;">
                  <button class="btn-edit-line" data-id="${line.id}" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">ç¼–è¾‘</button>
                  <button class="btn-delete-line" data-id="${line.id}" style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">åˆ é™¤</button>
                </div>
              </td>
            </tr>
          `;
        });

        tbody.innerHTML = html;

        // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
        tbody.querySelectorAll('.btn-edit-line').forEach(btn => {
          btn.addEventListener('click', () => {
            const lineId = btn.getAttribute('data-id');
            editLine(lineId);
          });
        });

        tbody.querySelectorAll('.btn-delete-line').forEach(btn => {
          btn.addEventListener('click', () => {
            const lineId = btn.getAttribute('data-id');
            deleteLine(lineId);
          });
        });
      }

      // ç¼–è¾‘çº¿è·¯
      function editLine(lineId) {
        // ç›´æ¥è·³è½¬åˆ°çº¿è·¯ç¼–è¾‘é¡µé¢
        window.location.href = `line-edit.html?id=${encodeURIComponent(lineId)}`;
      }

      // åˆ é™¤çº¿è·¯
      async function deleteLine(lineId) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤çº¿è·¯ "${lineId}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
          return;
        }

        try {
          const response = await fetch(`/api/lines/${encodeURIComponent(lineId)}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          alert('çº¿è·¯åˆ é™¤æˆåŠŸ');
          loadLines(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } catch (error) {
          console.error('åˆ é™¤çº¿è·¯å¤±è´¥:', error);
          alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
      }

      // äº‹ä»¶ç›‘å¬å™¨
      if (btnNewLine) {
        btnNewLine.addEventListener('click', () => {
          // ç›´æ¥è·³è½¬åˆ°çº¿è·¯ç¼–è¾‘é¡µé¢ï¼ˆæ–°å»ºæ¨¡å¼ï¼‰
          window.location.href = 'line-edit.html';
        });
      }

      if (btnRefreshLines) {
        btnRefreshLines.addEventListener('click', loadLines);
      }

      if (btnBackToList) {
        btnBackToList.addEventListener('click', () => {
          lineEditView.style.display = 'none';
          lineListView.style.display = 'block';
        });
      }

      if (searchLinesInput) {
        searchLinesInput.addEventListener('input', filterLines);
      }

      // åˆå§‹åŠ è½½
      loadLines();
    }

    // è½¦ç«™ç®¡ç†åŠŸèƒ½
    function initStationManagement() {
      const btnNewStation = document.getElementById('btn-new-station');
      const btnRefreshStations = document.getElementById('btn-refresh-stations');
      const btnBackToStationList = document.getElementById('btn-back-to-station-list');
      const searchStationsInput = document.getElementById('search-stations');
      const stationListView = document.getElementById('station-list-view');
      const stationEditView = document.getElementById('station-edit-view');
      const stationEditLink = document.getElementById('station-edit-link');

      if (!btnNewStation) return; // å¦‚æœä¸åœ¨è½¦ç«™ç®¡ç†æ ‡ç­¾é¡µï¼Œåˆ™è·³è¿‡

      let allStations = [];
      let filteredStations = [];

      // åŠ è½½è½¦ç«™åˆ—è¡¨
      async function loadStations() {
        try {
          const response = await fetch('/api/stations');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          allStations = await response.json();
          filterStations();
        } catch (error) {
          console.error('åŠ è½½è½¦ç«™åˆ—è¡¨å¤±è´¥:', error);
          updateStationsTable([{ error: true, message: 'åŠ è½½å¤±è´¥: ' + error.message }]);
        }
      }

      // è¿‡æ»¤è½¦ç«™
      function filterStations() {
        const searchTerm = searchStationsInput.value.toLowerCase().trim();
        if (!searchTerm) {
          filteredStations = allStations;
        } else {
          filteredStations = allStations.filter(station =>
            (station.code && station.code.toLowerCase().includes(searchTerm)) ||
            (station.name && station.name.toLowerCase().includes(searchTerm)) ||
            (station.en_name && station.en_name.toLowerCase().includes(searchTerm))
          );
        }
        updateStationsTable(filteredStations);
      }

      // æ›´æ–°è¡¨æ ¼
      function updateStationsTable(stations) {
        const tbody = document.getElementById('stations-tbody');
        if (!tbody) return;

        if (stations.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 40px; text-align: center; color: var(--muted);">
                æš‚æ— è½¦ç«™æ•°æ®
              </td>
            </tr>
          `;
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å¯¹è±¡
        if (stations[0] && stations[0].error) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 40px; text-align: center; color: var(--danger);">
                ${stations[0].message || 'åŠ è½½è½¦ç«™åˆ—è¡¨å¤±è´¥'}
              </td>
            </tr>
          `;
          return;
        }

        let html = '';
        stations.forEach(station => {
          const coordText = (station.x || station.y || station.z) ?
            `${station.x || 0}, ${station.y || 0}, ${station.z || 0}` : 'æœªè®¾ç½®';
          html += `
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 16px; color: var(--text);">
                <strong>${station.code || ''}</strong>
              </td>
              <td style="padding: 16px; color: var(--text);">
                ${station.name || ''}
              </td>
              <td style="padding: 16px; color: var(--text);">
                ${station.en_name || '-'}
              </td>
              <td style="padding: 16px; color: var(--text); font-family: monospace; font-size: 13px;">
                ${coordText}
              </td>
              <td style="padding: 16px;">
                <div style="display: flex; gap: 8px;">
                  <button class="btn-edit-station" data-code="${station.code}" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">ç¼–è¾‘</button>
                  <button class="btn-delete-station" data-code="${station.code}" style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">åˆ é™¤</button>
                </div>
              </td>
            </tr>
          `;
        });

        tbody.innerHTML = html;

        // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
        tbody.querySelectorAll('.btn-edit-station').forEach(btn => {
          btn.addEventListener('click', () => {
            const stationCode = btn.getAttribute('data-code');
            editStation(stationCode);
          });
        });

        tbody.querySelectorAll('.btn-delete-station').forEach(btn => {
          btn.addEventListener('click', () => {
            const stationCode = btn.getAttribute('data-code');
            deleteStation(stationCode);
          });
        });
      }

      // ç¼–è¾‘è½¦ç«™
      function editStation(stationCode) {
        // ç›´æ¥è·³è½¬åˆ°è½¦ç«™ç¼–è¾‘é¡µé¢
        window.location.href = `station-edit.html?code=${encodeURIComponent(stationCode)}`;
      }

      // åˆ é™¤è½¦ç«™
      async function deleteStation(stationCode) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤è½¦ç«™ "${stationCode}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
          return;
        }

        try {
          const response = await fetch(`/api/stations/${encodeURIComponent(stationCode)}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          alert('è½¦ç«™åˆ é™¤æˆåŠŸ');
          loadStations(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } catch (error) {
          console.error('åˆ é™¤è½¦ç«™å¤±è´¥:', error);
          alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
      }

      // äº‹ä»¶ç›‘å¬å™¨
      if (btnNewStation) {
        btnNewStation.addEventListener('click', () => {
          // ç›´æ¥è·³è½¬åˆ°è½¦ç«™ç¼–è¾‘é¡µé¢ï¼ˆæ–°å»ºæ¨¡å¼ï¼‰
          window.location.href = 'station-edit.html';
        });
      }

      if (btnRefreshStations) {
        btnRefreshStations.addEventListener('click', loadStations);
      }

      if (btnBackToStationList) {
        btnBackToStationList.addEventListener('click', () => {
          stationEditView.style.display = 'none';
          stationListView.style.display = 'block';
        });
      }

      if (searchStationsInput) {
        searchStationsInput.addEventListener('input', filterStations);
      }

      // åˆå§‹åŠ è½½
      loadStations();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–APIé…ç½®ç®¡ç†å™¨
      await ApiConfigManager.init();

      // è®¾ç½®ç³»ç»Ÿè®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      setupSystemSettings();

      // åŠ è½½ç»Ÿè®¡æ•°æ®
      loadStats();

      // åˆå§‹åŒ–çº¿è·¯ç®¡ç†
      initLineManagement();

      // åˆå§‹åŒ–è½¦ç«™ç®¡ç†
      initStationManagement();
    });
  </script>
</body>
</html>