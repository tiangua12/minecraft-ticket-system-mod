<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è½¦ç«™ç¼–è¾‘ - é“è·¯ç¥¨åŠ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        .station-edit-container {
            max-width: 100%;
            padding: 16px;
            box-sizing: border-box;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 16px; /* ç§»åŠ¨ç«¯å‹å¥½ */
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.1);
        }

        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--hover);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .section-title {
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
            color: var(--text);
            font-size: 18px;
            font-weight: bold;
        }

        .station-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
        }

        .station-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .station-item:hover {
            background: var(--hover);
        }

        .station-item.selected {
            background: rgba(var(--accent-rgb), 0.1);
            border-left: 4px solid var(--accent);
        }

        .station-code {
            font-family: monospace;
            font-weight: bold;
            color: var(--accent);
        }

        .station-name {
            margin-left: 8px;
            color: var(--text);
        }

        .station-coords {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 480px) {
            .form-row {
                flex-direction: column;
                gap: 12px;
            }

            .btn-group {
                flex-direction: column;
            }
        }

    /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
    .theme-toggle {
      position: absolute;
      top: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 16px;
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .theme-toggle:hover {
      background: var(--card);
    }

    .theme-icon {
      font-size: 18px;
    }
    </style>
    <script src="theme.js"></script>
</head>
<body>
    <div class="station-edit-container">
        <header class="brand" style="margin-bottom: 24px; position: relative;">
            <div class="brand-title">è½¦ç«™ç¼–è¾‘</div>
            <nav class="tabs">
                <button class="tab" onclick="window.location.href='index.html'">è¿”å›æ§åˆ¶å°</button>
            </nav>
            <button id="themeToggle" class="theme-toggle">
                <span class="theme-icon">ğŸŒ™</span>
                <span id="themeLabel">æ·±è‰²æ¨¡å¼</span>
            </button>
        </header>

        <div class="form-section">
            <h3 class="section-title">æ·»åŠ /ç¼–è¾‘è½¦ç«™</h3>

            <div class="form-group">
                <label class="form-label" for="station-code">è½¦ç«™ç¼–ç  *</label>
                <input type="text" id="station-code" class="form-input"
                       placeholder="ä¾‹å¦‚: 01-01"
                       pattern="\d{2}-\d{2}"
                       title="æ ¼å¼: ä¸¤ä½çº¿è·¯å·-ä¸¤ä½ç«™åºå· (å¦‚: 01-01)">
                <span class="form-hint">æ ¼å¼: çº¿è·¯å·-ç«™åºå·ï¼Œå¦‚ 01-01 (01å·çº¿ç¬¬1ç«™)</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="station-name">è½¦ç«™åç§° *</label>
                <input type="text" id="station-name" class="form-input"
                       placeholder="ä¾‹å¦‚: åŒ—äº¬ç«™">
                <span class="form-hint">ä¸­æ–‡è½¦ç«™åç§°</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="station-en-name">è‹±æ–‡åç§°</label>
                <input type="text" id="station-en-name" class="form-input"
                       placeholder="ä¾‹å¦‚: Beijing Station">
                <span class="form-hint">å¯é€‰ï¼Œç”¨äºå›½é™…ä¹˜å®¢</span>
            </div>

            <div class="section-title" style="margin-top: 32px;">åæ ‡ä¿¡æ¯ (å¯é€‰)</div>
            <div class="form-hint" style="margin-bottom: 16px;">
                åæ ‡ç”¨äºåœ°å›¾æ˜¾ç¤ºå’Œè·ç¦»è®¡ç®—ï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚ç•™ç©ºæˆ–å¡«0è¡¨ç¤ºä¸ä½¿ç”¨åæ ‡ã€‚
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="station-x">Xåæ ‡</label>
                    <input type="number" id="station-x" class="form-input"
                           placeholder="0" step="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="station-y">Yåæ ‡</label>
                    <input type="number" id="station-y" class="form-input"
                           placeholder="0" step="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="station-z">Zåæ ‡</label>
                    <input type="number" id="station-z" class="form-input"
                           placeholder="0" step="1">
                </div>
            </div>

            <div class="btn-group">
                <button id="btn-save" class="btn btn-primary">ä¿å­˜è½¦ç«™</button>
                <button id="btn-new" class="btn btn-secondary">æ–°å»ºè½¦ç«™</button>
                <button id="btn-delete" class="btn btn-danger" disabled>åˆ é™¤è½¦ç«™</button>
            </div>
        </div>

        <div class="form-section" style="margin-top: 40px;">
            <h3 class="section-title">ç°æœ‰è½¦ç«™</h3>
            <div class="form-hint" style="margin-bottom: 16px;">
                ç‚¹å‡»è½¦ç«™å¯ç¼–è¾‘ï¼Œä½¿ç”¨ä¸‹æ–¹æœç´¢æ¡†å¿«é€ŸæŸ¥æ‰¾ã€‚
            </div>

            <div class="form-group">
                <input type="text" id="search-stations" class="form-input"
                       placeholder="æœç´¢è½¦ç«™ç¼–ç æˆ–åç§°...">
            </div>

            <div id="station-list" class="station-list">
                <!-- è½¦ç«™åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentStation = null;
        let allStations = [];
        let filteredStations = [];

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼ˆä½¿ç”¨å…¬å…±æ¨¡å—ï¼‰
            window.ThemeManager.init();

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('btn-save').addEventListener('click', saveStation);
            document.getElementById('btn-new').addEventListener('click', newStation);
            document.getElementById('btn-delete').addEventListener('click', deleteStation);
            document.getElementById('search-stations').addEventListener('input', filterStations);

            // åŠ è½½è½¦ç«™åˆ—è¡¨
            loadStations();
        });

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';

            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            if (type === 'success') {
                toast.style.background = 'var(--success-bg, #d4edda)';
                toast.style.borderColor = 'var(--success-border, #c3e6cb)';
                toast.style.color = 'var(--success-text, #155724)';
            } else if (type === 'error') {
                toast.style.background = 'var(--error-bg, #f8d7da)';
                toast.style.borderColor = 'var(--error-border, #f5c6cb)';
                toast.style.color = 'var(--error-text, #721c24)';
            } else {
                toast.style.background = 'var(--card-bg)';
                toast.style.borderColor = 'var(--border)';
                toast.style.color = 'var(--text)';
            }

            toast.classList.add('show');

            // 3ç§’åéšè—
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ä»URLè·å–è½¦ç«™ç¼–ç å‚æ•°
        function getStationCodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('code') || params.get('id');
        }

        // å¦‚æœURLä¸­æœ‰è½¦ç«™ç¼–ç å‚æ•°ï¼Œè‡ªåŠ¨é€‰æ‹©è¯¥è½¦ç«™
        function selectStationIfUrlParam() {
            const stationCode = getStationCodeFromUrl();
            if (stationCode && allStations.length > 0) {
                // æŸ¥æ‰¾è½¦ç«™
                const station = allStations.find(s => s.code === stationCode);
                if (station) {
                    selectStation(stationCode);
                }
            }
        }

        // åŠ è½½è½¦ç«™åˆ—è¡¨
        async function loadStations() {
            try {
                const response = await fetch('/api/stations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                allStations = await response.json();
                filteredStations = [...allStations];
                renderStationList();
                selectStationIfUrlParam();

            } catch (error) {
                console.error('Failed to load stations:', error);
                showToast('åŠ è½½è½¦ç«™åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“è½¦ç«™åˆ—è¡¨
        function renderStationList() {
            const container = document.getElementById('station-list');

            if (filteredStations.length === 0) {
                container.innerHTML = `
                    <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        æš‚æ— è½¦ç«™æ•°æ®
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredStations.map(station => `
                <div class="station-item ${currentStation && currentStation.code === station.code ? 'selected' : ''}"
                     data-code="${station.code}"
                     onclick="selectStation('${station.code}')">
                    <span class="station-code">${station.code}</span>
                    <span class="station-name">${station.name}</span>
                    ${station.en_name ? `<br><small>${station.en_name}</small>` : ''}
                    ${station.x || station.y || station.z ?
                        `<span class="station-coords">åæ ‡: ${station.x || 0}, ${station.y || 0}, ${station.z || 0}</span>` :
                        ''}
                </div>
            `).join('');
        }

        // è¿‡æ»¤è½¦ç«™åˆ—è¡¨
        function filterStations() {
            const query = document.getElementById('search-stations').value.toLowerCase().trim();

            if (!query) {
                filteredStations = [...allStations];
            } else {
                filteredStations = allStations.filter(station =>
                    station.code.toLowerCase().includes(query) ||
                    station.name.toLowerCase().includes(query) ||
                    (station.en_name && station.en_name.toLowerCase().includes(query))
                );
            }

            renderStationList();
        }

        // é€‰æ‹©è½¦ç«™è¿›è¡Œç¼–è¾‘
        function selectStation(stationCode) {
            const station = allStations.find(s => s.code === stationCode);
            if (!station) return;

            currentStation = station;

            // å¡«å……è¡¨å•
            document.getElementById('station-code').value = station.code;
            document.getElementById('station-name').value = station.name;
            document.getElementById('station-en-name').value = station.en_name || '';
            document.getElementById('station-x').value = station.x || 0;
            document.getElementById('station-y').value = station.y || 0;
            document.getElementById('station-z').value = station.z || 0;

            // å¯ç”¨åˆ é™¤æŒ‰é’®
            document.getElementById('btn-delete').disabled = false;

            // æ›´æ–°åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            renderStationList();

            showToast(`å·²é€‰æ‹©è½¦ç«™: ${station.name}`, 'success');
        }

        // æ–°å»ºè½¦ç«™
        function newStation() {
            currentStation = null;

            // æ¸…ç©ºè¡¨å•
            document.getElementById('station-code').value = '';
            document.getElementById('station-name').value = '';
            document.getElementById('station-en-name').value = '';
            document.getElementById('station-x').value = 0;
            document.getElementById('station-y').value = 0;
            document.getElementById('station-z').value = 0;

            // ç¦ç”¨åˆ é™¤æŒ‰é’®
            document.getElementById('btn-delete').disabled = true;

            // æ›´æ–°åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            renderStationList();

            // ç„¦ç‚¹è®¾ç½®åˆ°ç¼–ç è¾“å…¥æ¡†
            document.getElementById('station-code').focus();

            showToast('å·²æ¸…ç©ºè¡¨å•ï¼Œå‡†å¤‡æ·»åŠ æ–°è½¦ç«™', 'info');
        }

        // ä¿å­˜è½¦ç«™
        async function saveStation() {
            const stationData = {
                code: document.getElementById('station-code').value.trim(),
                name: document.getElementById('station-name').value.trim(),
                en_name: document.getElementById('station-en-name').value.trim(),
                x: parseInt(document.getElementById('station-x').value) || 0,
                y: parseInt(document.getElementById('station-y').value) || 0,
                z: parseInt(document.getElementById('station-z').value) || 0
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!stationData.code) {
                showToast('è¯·è¾“å…¥è½¦ç«™ç¼–ç ', 'error');
                document.getElementById('station-code').focus();
                return;
            }

            if (!stationData.name) {
                showToast('è¯·è¾“å…¥è½¦ç«™åç§°', 'error');
                document.getElementById('station-name').focus();
                return;
            }

            // éªŒè¯ç¼–ç æ ¼å¼ï¼ˆå¯é€‰ï¼‰
            if (!/^\d{2}-\d{2}$/.test(stationData.code)) {
                showToast('è½¦ç«™ç¼–ç æ ¼å¼åº”ä¸º: ä¸¤ä½æ•°å­—-ä¸¤ä½æ•°å­— (å¦‚: 01-01)', 'error');
                document.getElementById('station-code').focus();
                return;
            }

            try {
                const method = currentStation ? 'PUT' : 'POST';
                const url = currentStation ? `/api/stations/${stationData.code}` : '/api/stations';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stationData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                showToast(currentStation ? 'è½¦ç«™æ›´æ–°æˆåŠŸ' : 'è½¦ç«™æ·»åŠ æˆåŠŸ', 'success');

                // é‡æ–°åŠ è½½åˆ—è¡¨
                await loadStations();

                // å¦‚æœæ˜¯æ–°è½¦ç«™ï¼Œé€‰ä¸­å®ƒ
                if (!currentStation) {
                    selectStation(stationData.code);
                }

            } catch (error) {
                console.error('Failed to save station:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤è½¦ç«™
        async function deleteStation() {
            if (!currentStation) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè½¦ç«™', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤è½¦ç«™ "${currentStation.name}" (${currentStation.code}) å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/stations/${currentStation.code}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                showToast('è½¦ç«™åˆ é™¤æˆåŠŸ', 'success');

                // æ¸…ç©ºè¡¨å•å¹¶é‡æ–°åŠ è½½åˆ—è¡¨
                newStation();
                await loadStations();

            } catch (error) {
                console.error('Failed to delete station:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºä¸ºå‡½æ•°ä¾›HTMLè°ƒç”¨
        window.selectStation = selectStation;
    </script>
</body>
</html>