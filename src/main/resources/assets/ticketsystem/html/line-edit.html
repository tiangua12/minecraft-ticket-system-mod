<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>çº¿è·¯ç¼–è¾‘ - é“è·¯ç¥¨åŠ¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ - ç«–æ’å¸ƒå±€ */
        .line-edit-container {
            max-width: 100%;
            padding: 16px;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(var(--accent-rgb), 0.1);
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-dark);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--hover);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .section-title {
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
            color: var(--text);
            font-size: 18px;
            font-weight: bold;
        }
        
        .station-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
        }
        
        .station-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: move; /* å¯æ‹–åŠ¨ */
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .station-item:hover {
            background: var(--hover);
        }
        
        .station-info {
            flex: 1;
        }
        
        .station-code {
            font-family: monospace;
            font-weight: bold;
            color: var(--accent);
        }
        
        .station-name {
            margin-left: 8px;
            color: var(--text);
        }
        
        .station-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            padding: 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .btn-icon:hover {
            color: var(--accent);
        }
        
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid var(--border);
        }
        
        .available-stations {
            margin-top: 20px;
        }
        
        .available-station-item {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .available-station-item:hover {
            background: var(--hover);
            border-color: var(--accent);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .station-item {
                flex-direction: column;
                align-items: flex-start;
            }
        
            .station-actions {
                margin-top: 8px;
                align-self: flex-end;
            }
        }
        
            /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
            .theme-toggle {
              position: absolute;
              top: 24px;
              right: 24px;
              background: var(--surface);
              border: 1px solid var(--border);
              border-radius: 12px;
              padding: 10px 16px;
              color: var(--text);
              cursor: pointer;
              font-weight: 700;
              display: flex;
              align-items: center;
              gap: 8px;
              transition: all 0.2s ease;
              z-index: 10;
            }
        
            .theme-toggle:hover {
              background: var(--card);
            }
        
            .theme-icon {
              font-size: 18px;
            }

            /* é€‰é¡¹å¡æ ·å¼ */
            .tab-button.active {
                border-bottom-color: var(--accent) !important;
                color: var(--accent) !important;
                font-weight: bold;
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
            .fare-item {
                padding: 12px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .fare-info {
                flex: 1;
            }
            .fare-price-input {
                width: 100px;
                padding: 6px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: var(--card-bg);
                color: var(--text);
            }
            .fare-actions {
                display: flex;
                gap: 8px;
            }
    </style>
    <script src="theme.js"></script>
</head>

<body>
    <div class="line-edit-container">
        <header class="brand" style="margin-bottom: 24px; position: relative;">
            <div class="brand-title">çº¿è·¯ç¼–è¾‘</div>
            <nav class="tabs">
                <button class="tab" onclick="window.location.href='index.html'">è¿”å›æ§åˆ¶å°</button>
            </nav>
            <button id="themeToggle" class="theme-toggle">
                <span class="theme-icon">ğŸŒ™</span>
                <span id="themeLabel">æ·±è‰²æ¨¡å¼</span>
            </button>
        </header>

        <div class="form-section">
            <h3 class="section-title">çº¿è·¯åŸºæœ¬ä¿¡æ¯</h3>

            <div class="form-group">
                <label class="form-label" for="line-id">çº¿è·¯ID *</label>
                <input type="text" id="line-id" class="form-input" placeholder="ä¾‹å¦‚: L1">
                <span class="form-hint">çº¿è·¯å”¯ä¸€æ ‡è¯†ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹</span>
            </div>

            <div class="form-group">
                <label class="form-label" for="line-name">çº¿è·¯åç§° *</label>
                <input type="text" id="line-name" class="form-input" placeholder="ä¾‹å¦‚: 1å·çº¿">
            </div>

            <div class="form-group">
                <label class="form-label" for="line-color">çº¿è·¯é¢œè‰²</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span class="color-preview" id="color-preview"></span>
                    <input type="text" id="line-color" class="form-input" placeholder="#3366CC æˆ– orange" style="flex: 1;">
                </div>
                <span class="form-hint">æ”¯æŒHEXé¢œè‰²ç æˆ–é¢œè‰²åç§°ï¼Œç”¨äºåœ°å›¾æ˜¾ç¤º</span>
            </div>
        </div>

        <div class="form-section" style="margin-top: 40px;">
            <div class="tabs-header" style="display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px;">
                <button class="tab-button active" data-tab="stations-tab" onclick="switchTab('stations-tab')" style="padding: 10px 20px; border: none; background: transparent; font-size: 16px; cursor: pointer; border-bottom: 2px solid transparent; margin-right: 10px; color: var(--text);">
                    è½¦ç«™é¡ºåº
                </button>
                <button class="tab-button" data-tab="fares-tab" onclick="switchTab('fares-tab')" style="padding: 10px 20px; border: none; background: transparent; font-size: 16px; cursor: pointer; border-bottom: 2px solid transparent; margin-right: 10px; color: var(--text);">
                    ç¥¨ä»·ç®¡ç†
                </button>
            </div>

            <!-- è½¦ç«™é¡ºåºé€‰é¡¹å¡ -->
            <div id="stations-tab" class="tab-content active">
                <div class="form-hint" style="margin-bottom: 16px;">
                    æ‹–åŠ¨è½¦ç«™è°ƒæ•´é¡ºåºï¼Œç‚¹å‡»Ã—ç§»é™¤è½¦ç«™ã€‚è½¦ç«™æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºæ’åˆ—ã€‚
                </div>

                <div id="line-stations-list" class="station-list">
                    <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        æš‚æ— è½¦ç«™ï¼Œä»ä¸‹æ–¹æ·»åŠ è½¦ç«™
                    </div>
                </div>
            </div>

            <!-- ç¥¨ä»·ç®¡ç†é€‰é¡¹å¡ -->
            <div id="fares-tab" class="tab-content" style="display: none;">
                <div class="form-hint" style="margin-bottom: 16px;">
                    ä¸ºçº¿è·¯ä¸­ç›¸é‚»è½¦ç«™è®¾ç½®ç¥¨ä»·ã€‚ç¥¨ä»·æŒ‰é“œå¸è®¡ç®—ã€‚
                </div>

                <div id="fares-list-container">
                    <div id="fares-list" class="station-list">
                        <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªè½¦ç«™ä»¥è®¾ç½®ç¥¨ä»·
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button id="btn-batch-set-fare" class="btn btn-secondary" onclick="showBatchFareDialog()" style="margin-right: 10px;" disabled>æ‰¹é‡è®¾ç½®ç¥¨ä»·</button>
                        <button id="btn-refresh-fares" class="btn btn-secondary" onclick="loadFares()">åˆ·æ–°ç¥¨ä»·</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section" style="margin-top: 40px;">
            <h3 class="section-title">æ·»åŠ è½¦ç«™</h3>
            <div class="form-hint" style="margin-bottom: 16px;">
                ä»æ‰€æœ‰è½¦ç«™ä¸­é€‰æ‹©æ·»åŠ åˆ°å½“å‰çº¿è·¯
            </div>

            <div class="form-group">
                <input type="text" id="search-available-stations" class="form-input" placeholder="æœç´¢è½¦ç«™ç¼–ç æˆ–åç§°...">
            </div>

            <div id="available-stations-list" class="available-stations">
                <!-- å¯ç”¨è½¦ç«™åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button id="btn-save" class="btn btn-primary">ä¿å­˜çº¿è·¯</button>
            <button id="btn-new" class="btn btn-secondary">æ–°å»ºçº¿è·¯</button>
            <button id="btn-delete" class="btn btn-danger" disabled>åˆ é™¤çº¿è·¯</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentLine = null;
        let lineStations = []; // å½“å‰çº¿è·¯çš„è½¦ç«™åˆ—è¡¨ï¼ˆæŒ‰é¡ºåºï¼‰
        let lineStationCodes = []; // è½¦ç«™ä»£ç æ•°ç»„ï¼ˆä»APIè·å–ï¼‰
        let allStations = []; // æ‰€æœ‰å¯ç”¨è½¦ç«™
        let filteredAvailableStations = [];
        
        // ä»URLè·å–çº¿è·¯ID
        function getLineIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼ˆä½¿ç”¨å…¬å…±æ¨¡å—ï¼‰
            window.ThemeManager.init();
        
            const lineId = getLineIdFromUrl();
        
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('btn-save').addEventListener('click', saveLine);
            document.getElementById('btn-new').addEventListener('click', newLine);
            document.getElementById('btn-delete').addEventListener('click', deleteLine);
            document.getElementById('search-available-stations').addEventListener('input', filterAvailableStations);
            document.getElementById('line-color').addEventListener('input', updateColorPreview);
        
            // åˆå§‹åŒ–é¢œè‰²é¢„è§ˆ
            updateColorPreview();
        
            if (lineId) {
                // ç¼–è¾‘ç°æœ‰çº¿è·¯
                loadLine(lineId);
            } else {
                // åˆ›å»ºæ–°çº¿è·¯
                newLine();
            }
        
            // åŠ è½½æ‰€æœ‰è½¦ç«™
            loadAllStations();
        });
        
        // æ›´æ–°é¢œè‰²é¢„è§ˆ
        function updateColorPreview() {
            const colorInput = document.getElementById('line-color');
            const preview = document.getElementById('color-preview');
            const color = colorInput.value.trim();
        
            if (color) {
                preview.style.backgroundColor = color;
                preview.style.display = 'inline-block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
        
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            if (type === 'success') {
                toast.style.background = 'var(--success-bg, #d4edda)';
                toast.style.borderColor = 'var(--success-border, #c3e6cb)';
                toast.style.color = 'var(--success-text, #155724)';
            } else if (type === 'error') {
                toast.style.background = 'var(--error-bg, #f8d7da)';
                toast.style.borderColor = 'var(--error-border, #f5c6cb)';
                toast.style.color = 'var(--error-text, #721c24)';
            } else {
                toast.style.background = 'var(--card-bg)';
                toast.style.borderColor = 'var(--border)';
                toast.style.color = 'var(--text)';
            }
        
            toast.classList.add('show');
        
            // 3ç§’åéšè—
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // åŠ è½½çº¿è·¯æ•°æ®
        async function loadLine(lineId) {
            try {
                const response = await fetch(`/api/lines/${lineId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
        
                currentLine = await response.json();
                lineStationCodes = currentLine.stations || [];
        
                // æ›´æ–°è¡¨å•
                document.getElementById('line-id').value = currentLine.id || '';
                document.getElementById('line-name').value = currentLine.name || '';
                document.getElementById('line-color').value = currentLine.color || '#3366CC';
                updateColorPreview();
        
                // å¯ç”¨åˆ é™¤æŒ‰é’®
                document.getElementById('btn-delete').disabled = false;
        
                // è§£æè½¦ç«™å¯¹è±¡å¹¶æ¸²æŸ“åˆ—è¡¨
                resolveLineStations();
        
                showToast('çº¿è·¯åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                showToast(`åŠ è½½çº¿è·¯å¤±è´¥: ${error.message}`, 'error');
                console.error('åŠ è½½çº¿è·¯å¤±è´¥:', error);
            }
        }

        // è§£æçº¿è·¯è½¦ç«™ä»£ç ä¸ºå®Œæ•´è½¦ç«™å¯¹è±¡
        function resolveLineStations() {
            // å°†è½¦ç«™ä»£ç æ•°ç»„æ˜ å°„ä¸ºå®Œæ•´è½¦ç«™å¯¹è±¡
            lineStations = lineStationCodes.map(code => {
                const station = allStations.find(s => s.code === code);
                return station || { code: code, name: code, en_name: '' };
            });
            // æ›´æ–°è½¦ç«™åˆ—è¡¨æ˜¾ç¤º
            renderLineStations();
            // æ›´æ–°å¯ç”¨è½¦ç«™è¿‡æ»¤
            filterAvailableStations();
        }

        // åŠ è½½æ‰€æœ‰è½¦ç«™
        async function loadAllStations() {
            try {
                const response = await fetch('/api/stations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
        
                allStations = await response.json();
                filterAvailableStations();
                resolveLineStations();
        
            } catch (error) {
                showToast(`åŠ è½½è½¦ç«™åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                console.error('åŠ è½½è½¦ç«™åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // è¿‡æ»¤å¯ç”¨è½¦ç«™ï¼ˆæ’é™¤å·²æ·»åŠ çš„è½¦ç«™ï¼‰
        function filterAvailableStations() {
            const searchTerm = document.getElementById('search-available-stations').value.toLowerCase();
            const addedStationCodes = lineStations.map(s => s.code);
        
            filteredAvailableStations = allStations.filter(station => {
                // æ’é™¤å·²æ·»åŠ çš„è½¦ç«™
                if (addedStationCodes.includes(station.code)) {
                    return false;
                }
        
                // æœç´¢è¿‡æ»¤
                if (!searchTerm) return true;
        
                return (
                    (station.code && station.code.toLowerCase().includes(searchTerm)) ||
                    (station.name && station.name.toLowerCase().includes(searchTerm)) ||
                    (station.en_name && station.en_name.toLowerCase().includes(searchTerm))
                );
            });
        
            renderAvailableStations();
        }
        
        // æ¸²æŸ“çº¿è·¯ä¸­çš„è½¦ç«™åˆ—è¡¨
        function renderLineStations() {
            const container = document.getElementById('line-stations-list');
        
            if (lineStations.length === 0) {
                container.innerHTML = `
                    <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        æš‚æ— è½¦ç«™ï¼Œä»ä¸‹æ–¹æ·»åŠ è½¦ç«™
                    </div>
                `;
                return;
            }
        
            let html = '';
            lineStations.forEach((station, index) => {
                html += `
                    <div class="station-item" data-index="${index}" draggable="true">
                        <div class="station-info">
                            <span class="station-code">${station.code || ''}</span>
                            <span class="station-name">${station.name || ''}</span>
                            ${station.en_name ? `<br><small>${station.en_name}</small>` : ''}
                        </div>
                        <div class="station-actions">
                            <button class="btn-icon" onclick="moveStationUp(${index})" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                            <button class="btn-icon" onclick="moveStationDown(${index})" ${index === lineStations.length - 1 ? 'disabled' : ''}>â†“</button>
                            <button class="btn-icon" onclick="removeStationFromLine(${index})">Ã—</button>
                        </div>
                    </div>
                `;
            });
        
            container.innerHTML = html;
        
            // æ·»åŠ æ‹–åŠ¨æ”¯æŒ
            setupDragAndDrop();
        }
        
        // æ¸²æŸ“å¯ç”¨è½¦ç«™åˆ—è¡¨
        function renderAvailableStations() {
            const container = document.getElementById('available-stations-list');
        
            if (filteredAvailableStations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        ${allStations.length === 0 ? 'æš‚æ— è½¦ç«™æ•°æ®' : 'æ— åŒ¹é…çš„è½¦ç«™'}
                    </div>
                `;
                return;
            }
        
            let html = '';
            filteredAvailableStations.forEach(station => {
                html += `
                    <div class="available-station-item" onclick="addStationToLine('${station.code}')">
                        <strong>${station.code || ''}</strong> - ${station.name || ''}
                        ${station.en_name ? `<br><small>${station.en_name}</small>` : ''}
                    </div>
                `;
            });
        
            container.innerHTML = html;
        }
        
        // è®¾ç½®æ‹–åŠ¨æ’åº
        function setupDragAndDrop() {
            const container = document.getElementById('line-stations-list');
            let draggedItem = null;
        
            container.querySelectorAll('.station-item[draggable="true"]').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => {
                        this.style.opacity = '0.4';
                    }, 0);
                });
        
                item.addEventListener('dragend', function(e) {
                    setTimeout(() => {
                        draggedItem.style.opacity = '';
                        draggedItem = null;
                    }, 0);
                });
        
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
        
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (draggedItem !== this) {
                        const fromIndex = parseInt(draggedItem.dataset.index);
                        const toIndex = parseInt(this.dataset.index);
        
                        // ç§»åŠ¨æ•°ç»„å…ƒç´ 
                        const [movedStation] = lineStations.splice(fromIndex, 1);
                        lineStations.splice(toIndex, 0, movedStation);
        
                        // é‡æ–°æ¸²æŸ“
                        renderLineStations();
                    }
                });
            });
        }
        
        // å‘ä¸Šç§»åŠ¨è½¦ç«™
        function moveStationUp(index) {
            if (index > 0) {
                [lineStations[index], lineStations[index - 1]] = [lineStations[index - 1], lineStations[index]];
                renderLineStations();
            }
        }
        
        // å‘ä¸‹ç§»åŠ¨è½¦ç«™
        function moveStationDown(index) {
            if (index < lineStations.length - 1) {
                [lineStations[index], lineStations[index + 1]] = [lineStations[index + 1], lineStations[index]];
                renderLineStations();
            }
        }
        
        // ä»çº¿è·¯ä¸­ç§»é™¤è½¦ç«™
        function removeStationFromLine(index) {
            lineStations.splice(index, 1);
            renderLineStations();
            filterAvailableStations(); // æ›´æ–°å¯ç”¨è½¦ç«™åˆ—è¡¨
        }
        
        // æ·»åŠ è½¦ç«™åˆ°çº¿è·¯
        function addStationToLine(stationCode) {
            const station = allStations.find(s => s.code === stationCode);
            if (station) {
                lineStations.push(station);
                renderLineStations();
                filterAvailableStations(); // æ›´æ–°å¯ç”¨è½¦ç«™åˆ—è¡¨
                showToast(`å·²æ·»åŠ è½¦ç«™: ${station.name}`, 'success');
            }
        }
        
        // ä¿å­˜çº¿è·¯
        async function saveLine() {
            const lineId = document.getElementById('line-id').value.trim();
            const lineName = document.getElementById('line-name').value.trim();
            const lineColor = document.getElementById('line-color').value.trim();
        
            if (!lineId) {
                showToast('è¯·è¾“å…¥çº¿è·¯ID', 'error');
                return;
            }
        
            if (!lineName) {
                showToast('è¯·è¾“å…¥çº¿è·¯åç§°', 'error');
                return;
            }
        
            if (lineStations.length < 2) {
                showToast('çº¿è·¯è‡³å°‘éœ€è¦2ä¸ªè½¦ç«™', 'error');
                return;
            }
        
            const lineData = {
                id: lineId,
                name: lineName,
                color: lineColor || '#3366CC',
                stations: lineStations.map(s => s.code) // åªå­˜å‚¨è½¦ç«™ç¼–ç 
            };
        
            try {
                const method = currentLine ? 'PUT' : 'POST';
                const url = currentLine ? `/api/lines/${lineId}` : '/api/lines';
        
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(lineData)
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
        
                showToast('çº¿è·¯ä¿å­˜æˆåŠŸ', 'success');
        
                // å¦‚æœæ˜¯æ–°å»ºçº¿è·¯ï¼Œæ›´æ–°å½“å‰çº¿è·¯å¯¹è±¡
                if (!currentLine) {
                    currentLine = lineData;
                    document.getElementById('btn-delete').disabled = false;
        
                    // æ›´æ–°URLä½†ä¸åˆ·æ–°é¡µé¢
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', lineId);
                    window.history.replaceState({}, '', newUrl);
                }
        
            } catch (error) {
                showToast(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                console.error('ä¿å­˜çº¿è·¯å¤±è´¥:', error);
            }
        }
        
        // æ–°å»ºçº¿è·¯
        function newLine() {
            currentLine = null;
            lineStations = [];
            lineStationCodes = [];
        
            // æ¸…ç©ºè¡¨å•
            document.getElementById('line-id').value = '';
            document.getElementById('line-name').value = '';
            document.getElementById('line-color').value = '#3366CC';
            updateColorPreview();
        
            // ç¦ç”¨åˆ é™¤æŒ‰é’®
            document.getElementById('btn-delete').disabled = true;
        
            // æ¸…ç©ºè½¦ç«™åˆ—è¡¨
            renderLineStations();
            filterAvailableStations();
        
            // ç§»é™¤URLä¸­çš„IDå‚æ•°
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            window.history.replaceState({}, '', newUrl);
        
            showToast('å·²å‡†å¤‡æ–°å»ºçº¿è·¯', 'info');
        }
        
        // åˆ é™¤çº¿è·¯
        async function deleteLine() {
            if (!currentLine || !confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡çº¿è·¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
        
            try {
                const response = await fetch(`/api/lines/${currentLine.id}`, {
                    method: 'DELETE'
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
        
                showToast('çº¿è·¯åˆ é™¤æˆåŠŸ', 'success');
        
                // è¿”å›åˆ°çº¿è·¯é€‰æ‹©é¡µé¢
                setTimeout(() => {
                    window.location.href = 'index.html#tab-line-select';
                }, 1500);
        
            } catch (error) {
                showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                console.error('åˆ é™¤çº¿è·¯å¤±è´¥:', error);
            }
        }

        // é€‰é¡¹å¡åˆ‡æ¢
        function switchTab(tabId) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„é€‰é¡¹å¡å†…å®¹
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }

            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            const selectedButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // å¦‚æœåˆ‡æ¢åˆ°ç¥¨ä»·ç®¡ç†é€‰é¡¹å¡ï¼ŒåŠ è½½ç¥¨ä»·æ•°æ®
            if (tabId === 'fares-tab') {
                loadFares();
            }
        }

        // åŠ è½½ç¥¨ä»·æ•°æ®
        async function loadFares() {
            if (lineStations.length < 2) {
                document.getElementById('fares-list').innerHTML = `
                    <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªè½¦ç«™ä»¥è®¾ç½®ç¥¨ä»·
                    </div>
                `;
                document.getElementById('btn-batch-set-fare').disabled = true;
                return;
            }

            document.getElementById('btn-batch-set-fare').disabled = false;

            try {
                // è·å–æ‰€æœ‰ç¥¨ä»·æ•°æ®
                const response = await fetch('/api/fares');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const allFares = await response.json();

                // ç”Ÿæˆç›¸é‚»è½¦ç«™å¯¹
                const fareSegments = [];
                for (let i = 0; i < lineStations.length - 1; i++) {
                    const fromStation = lineStations[i];
                    const toStation = lineStations[i + 1];

                    // æŸ¥æ‰¾ç¥¨ä»·
                    const fare = allFares.find(f =>
                        (f.fromStation === fromStation.code && f.toStation === toStation.code) ||
                        (f.fromStation === toStation.code && f.toStation === fromStation.code)
                    );

                    fareSegments.push({
                        from: fromStation,
                        to: toStation,
                        fare: fare,
                        index: i
                    });
                }

                renderFaresList(fareSegments);

            } catch (error) {
                showToast(`åŠ è½½ç¥¨ä»·å¤±è´¥: ${error.message}`, 'error');
                console.error('åŠ è½½ç¥¨ä»·å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç¥¨ä»·åˆ—è¡¨
        function renderFaresList(fareSegments) {
            const container = document.getElementById('fares-list');

            if (fareSegments.length === 0) {
                container.innerHTML = `
                    <div class="station-item" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªè½¦ç«™ä»¥è®¾ç½®ç¥¨ä»·
                    </div>
                `;
                return;
            }

            let html = '';
            fareSegments.forEach(segment => {
                const currentPrice = (segment.fare && segment.fare.price != null) ? segment.fare.price : 0;
                html += `
                    <div class="fare-item" data-index="${segment.index}">
                        <div class="fare-info">
                            <div>
                                <strong>${segment.from.name} (${segment.from.code})</strong>
                                â†’
                                <strong>${segment.to.name} (${segment.to.code})</strong>
                            </div>
                            <div style="margin-top: 4px; font-size: 14px; color: var(--text-secondary);">
                                åŒºé—´ ${segment.index + 1}/${fareSegments.length}
                            </div>
                        </div>
                        <div class="fare-actions">
                            <input type="number"
                                   class="fare-price-input"
                                   id="fare-price-${segment.index}"
                                   value="${currentPrice}"
                                   min="1"
                                   max="9999"
                                   placeholder="ç¥¨ä»·">
                            <button class="btn-icon" onclick="saveFare(${segment.index})">ä¿å­˜</button>
                            <button class="btn-icon" onclick="deleteFare(${segment.index})" ${currentPrice === 0 ? 'disabled' : ''}>åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ä¿å­˜ç¥¨ä»·
        async function saveFare(segmentIndex) {
            if (segmentIndex < 0 || segmentIndex >= lineStations.length - 1) {
                return;
            }

            const fromStation = lineStations[segmentIndex];
            const toStation = lineStations[segmentIndex + 1];
            const priceInput = document.getElementById(`fare-price-${segmentIndex}`);
            const price = parseInt(priceInput.value);

            if (!price || price < 1) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¥¨ä»·ï¼ˆå¤§äº0ï¼‰', 'error');
                return;
            }

            try {
                const fareData = {
                    fromStation: fromStation.code,
                    toStation: toStation.code,
                    price: price
                };

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç¥¨ä»·
                const checkResponse = await fetch(`/api/fares/${fromStation.code}/${toStation.code}`);
                const method = checkResponse.ok ? 'PUT' : 'POST';
                const url = method === 'PUT'
                    ? `/api/fares/${fromStation.code}/${toStation.code}`
                    : '/api/fares';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fareData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showToast('ç¥¨ä»·ä¿å­˜æˆåŠŸ', 'success');

                // é‡æ–°åŠ è½½ç¥¨ä»·åˆ—è¡¨
                loadFares();

            } catch (error) {
                showToast(`ä¿å­˜ç¥¨ä»·å¤±è´¥: ${error.message}`, 'error');
                console.error('ä¿å­˜ç¥¨ä»·å¤±è´¥:', error);
            }
        }

        // åˆ é™¤ç¥¨ä»·
        async function deleteFare(segmentIndex) {
            if (segmentIndex < 0 || segmentIndex >= lineStations.length - 1) {
                return;
            }

            const fromStation = lineStations[segmentIndex];
            const toStation = lineStations[segmentIndex + 1];

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${fromStation.name} â†’ ${toStation.name} çš„ç¥¨ä»·å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/fares/${fromStation.code}/${toStation.code}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                showToast('ç¥¨ä»·åˆ é™¤æˆåŠŸ', 'success');

                // é‡æ–°åŠ è½½ç¥¨ä»·åˆ—è¡¨
                loadFares();

            } catch (error) {
                showToast(`åˆ é™¤ç¥¨ä»·å¤±è´¥: ${error.message}`, 'error');
                console.error('åˆ é™¤ç¥¨ä»·å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡è®¾ç½®ç¥¨ä»·å¯¹è¯æ¡†
        function showBatchFareDialog() {
            const price = prompt('è¯·è¾“å…¥ç»Ÿä¸€çš„ç¥¨ä»·ï¼ˆé“œå¸ï¼‰:', '10');
            if (price === null) return;

            const priceNum = parseInt(price);
            if (!priceNum || priceNum < 1) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¥¨ä»·ï¼ˆå¤§äº0ï¼‰', 'error');
                return;
            }

            if (confirm(`ç¡®å®šè¦ä¸ºæ‰€æœ‰${lineStations.length - 1}ä¸ªåŒºé—´è®¾ç½®ç»Ÿä¸€ç¥¨ä»· ${priceNum} é“œå¸å—ï¼Ÿ`)) {
                batchSetFare(priceNum);
            }
        }

        // æ‰¹é‡è®¾ç½®ç¥¨ä»·
        async function batchSetFare(price) {
            try {
                const promises = [];

                for (let i = 0; i < lineStations.length - 1; i++) {
                    const fromStation = lineStations[i];
                    const toStation = lineStations[i + 1];

                    const fareData = {
                        fromStation: fromStation.code,
                        toStation: toStation.code,
                        price: price
                    };

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç¥¨ä»·
                    const checkResponse = await fetch(`/api/fares/${fromStation.code}/${toStation.code}`);
                    const method = checkResponse.ok ? 'PUT' : 'POST';
                    const url = method === 'PUT'
                        ? `/api/fares/${fromStation.code}/${toStation.code}`
                        : '/api/fares';

                    promises.push(
                        fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(fareData)
                        })
                    );
                }

                await Promise.all(promises);
                showToast(`æˆåŠŸä¸º${lineStations.length - 1}ä¸ªåŒºé—´è®¾ç½®ç¥¨ä»·`, 'success');

                // é‡æ–°åŠ è½½ç¥¨ä»·åˆ—è¡¨
                loadFares();

            } catch (error) {
                showToast(`æ‰¹é‡è®¾ç½®ç¥¨ä»·å¤±è´¥: ${error.message}`, 'error');
                console.error('æ‰¹é‡è®¾ç½®ç¥¨ä»·å¤±è´¥:', error);
            }
        }
    </script>
</body>

</html>