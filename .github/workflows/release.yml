name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ä»¥ä¾¿æ­£ç¡®æ ‡è®°

      # 2. è®¾ç½®JDK 17ï¼ˆMinecraft 1.20.1éœ€è¦Java 17ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. ç¼“å­˜Gradleä¾èµ–é¡¹ä»¥åŠ é€Ÿæ„å»º
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. ä½¿gradlewå¯æ‰§è¡Œ
      - name: Make gradlew executable
        run: chmod +x gradlew

      # 5. æ„å»ºé¡¹ç›®
      - name: Build with Gradle
        run: ./gradlew build

      # 6. æå–ç‰ˆæœ¬ä¿¡æ¯
      - name: Extract version info
        id: version
        run: |
          # ä»gradle.propertiesè¯»å–ç‰ˆæœ¬å·
          VERSION=$(grep 'mod_version' gradle.properties | cut -d'=' -f2)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

          # ä»tagåè·å–releaseåç§°ï¼ˆå¦‚æœæ²¡æœ‰tagåˆ™ä½¿ç”¨gradleç‰ˆæœ¬ï¼‰
          if [[ -n "${{ github.ref_name }}" ]]; then
            TAG_NAME="${{ github.ref_name }}"
            # ç§»é™¤vå‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            RELEASE_NAME="${TAG_NAME#v}"
          else
            RELEASE_NAME="${VERSION}"
          fi
          echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${TAG_NAME:-v${VERSION}}" >> $GITHUB_OUTPUT

          echo "Build version: ${VERSION}"
          echo "Release name: ${RELEASE_NAME}"
          echo "Tag name: ${TAG_NAME:-v${VERSION}}"

      # 7. åˆ—å‡ºæ„å»ºäº§ç‰©
      - name: List build artifacts
        run: |
          echo "=== Build output directory ==="
          ls -la build/libs/
          echo "=== JAR files ==="
          find build/libs -name "*.jar" -type f | xargs ls -lh

      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºå·¥ä½œæµåˆ¶å“ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mod-jar-${{ steps.version.outputs.RELEASE_NAME }}
          path: build/libs/*.jar
          retention-days: 7

      # 9. åˆ›å»ºGitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "Version ${{ steps.version.outputs.RELEASE_NAME }}"
          body: |
            ## Minecraft Ticket System Mod v${{ steps.version.outputs.RELEASE_NAME }}

            **è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ**

            ### æ„å»ºä¿¡æ¯
            - ç‰ˆæœ¬: ${{ steps.version.outputs.VERSION }}
            - Java: 17
            - Minecraft: 1.20.1
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}

            ### è®¸å¯è¯
            æœ¬é¡¹ç›®é‡‡ç”¨GPLv3è®¸å¯è¯å‘å¸ƒï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

            åŒ…å«åŸºäºMITè®¸å¯è¯çš„å‰ç«¯ä»£ç ï¼Œè¯¦è§NOTICE.txtã€‚

            ### ä½¿ç”¨è¯´æ˜
            1. å°†JARæ–‡ä»¶æ”¾å…¥Minecraftçš„`mods`æ–‡ä»¶å¤¹
            2. éœ€è¦Forge 47.4.0æˆ–æ›´é«˜ç‰ˆæœ¬
            3. æ”¯æŒMinecraft 1.20.1

            ### å˜æ›´æ—¥å¿—
            è¯·æŸ¥çœ‹changelog.txtè·å–è¯¦ç»†å˜æ›´ä¿¡æ¯ã€‚

            *è‡ªåŠ¨ç”ŸæˆäºGitHub Actions*
          draft: false
          prerelease: false
          files: |
            build/libs/*.jar
            LICENSE
            MIT-LICENSE.txt
            NOTICE.txt
            CREDITS.txt
            changelog.txt
          token: ${{ secrets.GITHUB_TOKEN }}

      # 10. è¾“å‡ºå‘å¸ƒä¿¡æ¯
      - name: Show release info
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "Version: ${{ steps.version.outputs.RELEASE_NAME }}"
          echo "Tag: ${{ steps.version.outputs.TAG_NAME }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }}"